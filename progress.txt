## Codebase Patterns
- Next.js 14+ App Router with src/ directory and @/* import alias
- shadcn/ui initialized with Tailwind v4, CSS variables
- MongoDB connection uses global cache singleton pattern in src/lib/db.ts
- Type definitions live in src/lib/types/
- Auth config in src/lib/auth.ts using next-auth
- User model in src/lib/models/user.ts (Mongoose)
- NextAuth v5 beta uses `next-auth/providers/credentials` and `next-auth/providers/github` imports
- Signup is a custom API route at /api/auth/signup (not part of NextAuth)
- Auth pages use route group `(auth)` with login/ and signup/ directories
- shadcn/ui components added via `npx shadcn@latest add <component>`
- SessionProvider wrapper lives in src/components/session-provider.tsx (client component)
- UserMenu component uses useSession() from next-auth/react for client-side session access
- Root layout wraps children with AuthSessionProvider for client-side session access
- AppShell component provides shared layout (header + sidebar + main content area)
- Sidebar fetches projects from /api/projects on each pathname change
- Project model in src/lib/models/project.ts (Mongoose)
- Projects API at /api/projects (GET list, POST create)
- Middleware matcher must include /projects/:path* for auth protection
- Project settings page at /projects/[id]/settings — server component with client form components
- API routes for project sub-resources follow /api/projects/[id]/{resource} pattern
- Never return secrets from API — use boolean flags (e.g., hasAccessToken) or maskedValue
- Env vars stored with maskedValue in DB to avoid decrypting for display
- API sub-resources: /api/projects/[id]/env-vars for env var CRUD
- API sub-resources: /api/projects/[id]/provider-keys for provider key CRUD (PUT to add/replace, DELETE to remove)
- ProviderKeyForm component is reusable for all providers (claude-code, codeex, opencode)
- Project-level mutations (rename, delete) use /api/projects/[id] route with PATCH/DELETE methods
---

## 2026-01-28 - US-01
- Implemented sign up and sign in with email/password credentials and GitHub OAuth
- Configured NextAuth.js with JWT sessions (7-day expiry), credentials + GitHub providers
- Created User Mongoose model with email, password (bcrypt hashed), name, emailVerified fields
- Built login page with email/password form and GitHub OAuth button
- Built signup page with name/email/password form and GitHub OAuth button
- Created /api/auth/signup POST route with validation and bcrypt hashing
- Created /api/auth/[...nextauth] route handler
- Added middleware for protected routes
- Updated home page to redirect based on auth state
- Files changed:
  - src/lib/auth.ts (NextAuth config)
  - src/lib/models/user.ts (new)
  - src/app/api/auth/[...nextauth]/route.ts (new)
  - src/app/api/auth/signup/route.ts (new)
  - src/app/(auth)/login/page.tsx (new)
  - src/app/(auth)/signup/page.tsx (new)
  - src/middleware.ts (new)
  - src/app/page.tsx (updated to redirect)
  - src/components/ui/ (button, input, label, card, separator via shadcn)
- **Learnings for future iterations:**
  - NextAuth v5 beta exports `auth` which can be used directly as middleware export
  - GitHub OAuth auto-creates users in the signIn callback (no adapter needed for basic flow)
  - Email verification is a TODO - placeholder noted in signup route
  - bcryptjs used instead of bcrypt for easier cross-platform install
---

## 2026-01-28 - US-02
- Implemented sign out via user menu dropdown
- Created UserMenu client component with avatar, dropdown, and sign out action
- Created AuthSessionProvider wrapper for next-auth/react SessionProvider
- Wrapped root layout with AuthSessionProvider
- Created /inbox page as authenticated landing page with header and UserMenu
- Added shadcn dropdown-menu and avatar components
- Files changed:
  - src/components/user-menu.tsx (new)
  - src/components/session-provider.tsx (new)
  - src/app/layout.tsx (updated - added SessionProvider wrapper, updated metadata)
  - src/app/inbox/page.tsx (new)
  - src/components/ui/dropdown-menu.tsx (new - shadcn)
  - src/components/ui/avatar.tsx (new - shadcn)
- **Learnings for future iterations:**
  - next-auth/react `signOut({ callbackUrl: "/login" })` handles JWT invalidation and redirect
  - `useSession()` requires SessionProvider ancestor - wrapped in root layout
  - UserMenu is a client component; inbox page is a server component that renders it
---

## 2026-01-28 - US-04
- Implemented project creation with sidebar, dialog form, API, and workspace page
- Created Project Mongoose model with userId, name, description, repoUrl fields
- Created /api/projects route with POST (create) and GET (list by user)
- Built Sidebar component with project list and "New Project" button
- Built NewProjectDialog with name (required), description (optional), repoUrl (optional)
- Created AppShell component (header + sidebar + main content)
- Created /projects/[id] workspace page showing project details
- Updated inbox page to use AppShell layout
- Updated middleware matcher to protect /projects routes
- Added shadcn dialog and textarea components
- Files changed:
  - src/lib/models/project.ts (new)
  - src/app/api/projects/route.ts (new)
  - src/components/sidebar.tsx (new)
  - src/components/new-project-dialog.tsx (new)
  - src/components/app-shell.tsx (new)
  - src/app/projects/[id]/page.tsx (new)
  - src/app/inbox/page.tsx (updated - uses AppShell)
  - src/middleware.ts (updated - added /projects matcher)
  - src/components/ui/dialog.tsx (new - shadcn)
  - src/components/ui/textarea.tsx (new - shadcn)
- **Learnings for future iterations:**
  - AppShell wraps authenticated pages with header + sidebar layout
  - Sidebar re-fetches project list on pathname change (useEffect dep on pathname)
  - Next.js 15 params are Promises — must await them in page components
  - Project pages check userId ownership before rendering
---

## 2026-01-29 - US-04a
- Implemented repository configuration for projects
- Added `repo` subdocument (url, branch, accessTokenArn) to Project Mongoose model
- Created PUT/GET API at /api/projects/[id]/repo with HTTPS Git URL validation
- Built RepoConfigForm client component with URL, branch, access token fields
- Created project settings page at /projects/[id]/settings with repo config section
- Added settings link to project workspace page
- Test Clone button validates URL format (full clone test deferred to backend infra)
- Files changed:
  - src/lib/models/project.ts (updated - added repo subdocument schema)
  - src/app/api/projects/[id]/repo/route.ts (new)
  - src/components/repo-config-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (new)
  - src/app/projects/[id]/page.tsx (updated - added settings link)
  - prd.json (updated - US-04a passes: true)
- **Learnings for future iterations:**
  - Mongoose subdocuments use `{ _id: false }` to avoid auto-generated _id
  - API never returns raw access tokens — only `hasAccessToken` boolean
  - Project settings page is at /projects/[id]/settings (server component renders client form)
  - HTTPS Git URL regex: `/^https:\/\/.+\.git$/`
  - Full clone test requires backend infrastructure (Lambda or similar) — stubbed for now
---

## 2026-01-29 - US-04b
- Implemented agent environment variables configuration for projects
- Added IEnvVar interface and EnvVarSchema to Project model (key, valueArn, source, maskedValue)
- Created /api/projects/[id]/env-vars route with GET, PUT, DELETE methods
- Built EnvVarsConfigForm client component with add/edit/delete key-value pairs
- Added merged env vars preview with masked values and source badges (platform/user)
- Integrated env vars section into project settings page
- Files changed:
  - src/lib/models/project.ts (updated - added IEnvVar, EnvVarSchema, envVars field)
  - src/app/api/projects/[id]/env-vars/route.ts (new)
  - src/components/env-vars-config-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (updated - added env vars section)
  - prd.json (updated - US-04b passes: true)
- **Learnings for future iterations:**
  - Env var keys validated with regex `^[A-Za-z_][A-Za-z0-9_]*$`
  - maskedValue stored in DB to avoid decrypting secrets just to display them
  - API never returns actual secret values — only masked versions
  - Source field distinguishes "platform" (auto-injected provider keys) from "user" (custom)
  - AWS Secrets Manager integration is stubbed with `pending-encryption` placeholder ARN
---

## 2026-01-29 - US-05
- Implemented project rename via settings page
- Created PATCH /api/projects/[id] endpoint with name validation (non-empty, max 100 chars)
- Created ProjectRenameForm client component with inline validation, success/error feedback
- Added "Project Name" section to project settings page (above repo config)
- router.refresh() updates sidebar and header after rename
- Files changed:
  - src/app/api/projects/[id]/route.ts (new)
  - src/components/project-rename-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (updated - added rename section)
  - prd.json (updated - US-05 passes: true)
- **Learnings for future iterations:**
  - Project-level API routes go at /api/projects/[id]/route.ts (PATCH, DELETE, etc.)
  - router.refresh() from next/navigation re-fetches server components, updating sidebar project names
  - Settings page sections order: Project Name > Repository > Env Vars > Danger Zone (delete)
---

## 2026-01-29 - US-06
- Implemented project deletion with confirmation dialog requiring project name typed to confirm
- Added DELETE method to /api/projects/[id] route (findOneAndDelete with userId check)
- Created ProjectDeleteSection client component with two-step confirmation (button → type name → delete)
- Added "Danger Zone" section at bottom of project settings page with destructive styling
- Redirects to /inbox after successful deletion, router.refresh() updates sidebar
- Files changed:
  - src/app/api/projects/[id]/route.ts (updated - added DELETE handler)
  - src/components/project-delete-section.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (updated - added danger zone section)
  - prd.json (updated - US-06 passes: true)
- **Learnings for future iterations:**
  - Danger zone pattern: separate section at bottom with destructive border, requires typing entity name to confirm
  - DELETE endpoint uses findOneAndDelete with userId ownership check
  - Cascade delete for runs/drafts/IaC is handled at DB level when those models exist (currently only project doc)
---

## 2026-01-29 - US-07
- Implemented project switcher dropdown in sidebar (appears when >1 project exists)
- Added localStorage persistence for last-used project ID (key: ralph-last-project-id)
- Created LastProjectRedirect client component that auto-redirects from /inbox to last-used project
- Sidebar saves current project ID to localStorage on navigation
- Files changed:
  - src/components/sidebar.tsx (updated - added switcher dropdown, localStorage helpers, exported getLastProjectId/setLastProjectId)
  - src/components/last-project-redirect.tsx (new - client component for auto-redirect)
  - src/app/inbox/page.tsx (updated - added LastProjectRedirect component)
  - prd.json (updated - US-07 passes: true)
- **Learnings for future iterations:**
  - localStorage helpers (getLastProjectId, setLastProjectId) exported from sidebar.tsx for reuse
  - Project switcher only renders when projects.length > 1 (no switcher for single project)
  - LastProjectRedirect uses router.replace() to avoid adding /inbox to history stack
  - extractProjectId() regex extracts project ID from any /projects/[id]/* pathname
---

## 2026-01-29 - US-08
- Implemented Claude Code API key configuration on project settings page
- Added IProviderKey interface and ProviderKeySchema to Project model (provider, keyArn, maskedValue)
- Created /api/projects/[id]/provider-keys route with GET, PUT, DELETE methods
- Built ProviderKeyForm client component with save, replace, and test-connection functionality
- Added "Provider API Keys" section to project settings page (between Repository and Env Vars)
- Test button validates Claude Code key format (sk-ant- prefix); full API validation deferred to backend
- Files changed:
  - src/lib/models/project.ts (updated - added IProviderKey, ProviderKeySchema, providerKeys field)
  - src/app/api/projects/[id]/provider-keys/route.ts (new)
  - src/components/provider-key-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (updated - added Provider API Keys section)
  - prd.json (updated - US-08 passes: true)
- **Learnings for future iterations:**
  - Provider keys follow same pattern as env vars: masked values stored in DB, never return actual keys
  - VALID_PROVIDERS constant defines allowed providers: claude-code, codeex, opencode
  - ProviderKeyForm is reusable for all providers — just change provider/label/placeholder props
  - Settings page section order: Project Name > Repository > Provider API Keys > Env Vars > Danger Zone
---

