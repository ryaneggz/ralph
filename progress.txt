## Codebase Patterns
- Next.js 14+ App Router with src/ directory and @/* import alias
- shadcn/ui initialized with Tailwind v4, CSS variables
- MongoDB connection uses global cache singleton pattern in src/lib/db.ts
- Type definitions live in src/lib/types/
- Auth config in src/lib/auth.ts using next-auth
- User model in src/lib/models/user.ts (Mongoose)
- NextAuth v5 beta uses `next-auth/providers/credentials` and `next-auth/providers/github` imports
- Signup is a custom API route at /api/auth/signup (not part of NextAuth)
- Auth pages use route group `(auth)` with login/ and signup/ directories
- shadcn/ui components added via `npx shadcn@latest add <component>`
- SessionProvider wrapper lives in src/components/session-provider.tsx (client component)
- UserMenu component uses useSession() from next-auth/react for client-side session access
- Root layout wraps children with AuthSessionProvider for client-side session access
- AppShell component provides shared layout (header + sidebar + main content area)
- Sidebar fetches projects from /api/projects on each pathname change
- Project model in src/lib/models/project.ts (Mongoose)
- Projects API at /api/projects (GET list, POST create)
- Middleware matcher must include /projects/:path* for auth protection
- Project settings page at /projects/[id]/settings — server component with client form components
- API routes for project sub-resources follow /api/projects/[id]/{resource} pattern
- Never return secrets from API — use boolean flags (e.g., hasAccessToken) or maskedValue
- AES-256-GCM encryption via src/lib/crypto.ts — uses ENCRYPTION_KEY env var, SHA-256 derived key
- AuditLog model in src/lib/models/audit-log.ts — logAudit() is fire-and-forget (non-blocking)
- Env vars stored with maskedValue in DB to avoid decrypting for display
- API sub-resources: /api/projects/[id]/env-vars for env var CRUD
- API sub-resources: /api/projects/[id]/provider-keys for provider key CRUD (PUT to add/replace, DELETE to remove)
- IaC templates defined in src/lib/iac-templates.ts — IAC_TEMPLATE_IDS for validation, IAC_TEMPLATES for display
- ProviderKeyForm component is reusable for all providers (claude-code, codeex, opencode)
- Project-level mutations (rename, delete, config) use /api/projects/[id] route with PATCH/DELETE methods
- AWS regions list shared via src/lib/aws-regions.ts — use for any AWS region dropdowns/validation
---

## 2026-01-28 - US-01
- Implemented sign up and sign in with email/password credentials and GitHub OAuth
- Configured NextAuth.js with JWT sessions (7-day expiry), credentials + GitHub providers
- Created User Mongoose model with email, password (bcrypt hashed), name, emailVerified fields
- Built login page with email/password form and GitHub OAuth button
- Built signup page with name/email/password form and GitHub OAuth button
- Created /api/auth/signup POST route with validation and bcrypt hashing
- Created /api/auth/[...nextauth] route handler
- Added middleware for protected routes
- Updated home page to redirect based on auth state
- Files changed:
  - src/lib/auth.ts (NextAuth config)
  - src/lib/models/user.ts (new)
  - src/app/api/auth/[...nextauth]/route.ts (new)
  - src/app/api/auth/signup/route.ts (new)
  - src/app/(auth)/login/page.tsx (new)
  - src/app/(auth)/signup/page.tsx (new)
  - src/middleware.ts (new)
  - src/app/page.tsx (updated to redirect)
  - src/components/ui/ (button, input, label, card, separator via shadcn)
- **Learnings for future iterations:**
  - NextAuth v5 beta exports `auth` which can be used directly as middleware export
  - GitHub OAuth auto-creates users in the signIn callback (no adapter needed for basic flow)
  - Email verification is a TODO - placeholder noted in signup route
  - bcryptjs used instead of bcrypt for easier cross-platform install
---

## 2026-01-28 - US-02
- Implemented sign out via user menu dropdown
- Created UserMenu client component with avatar, dropdown, and sign out action
- Created AuthSessionProvider wrapper for next-auth/react SessionProvider
- Wrapped root layout with AuthSessionProvider
- Created /inbox page as authenticated landing page with header and UserMenu
- Added shadcn dropdown-menu and avatar components
- Files changed:
  - src/components/user-menu.tsx (new)
  - src/components/session-provider.tsx (new)
  - src/app/layout.tsx (updated - added SessionProvider wrapper, updated metadata)
  - src/app/inbox/page.tsx (new)
  - src/components/ui/dropdown-menu.tsx (new - shadcn)
  - src/components/ui/avatar.tsx (new - shadcn)
- **Learnings for future iterations:**
  - next-auth/react `signOut({ callbackUrl: "/login" })` handles JWT invalidation and redirect
  - `useSession()` requires SessionProvider ancestor - wrapped in root layout
  - UserMenu is a client component; inbox page is a server component that renders it
---

## 2026-01-28 - US-04
- Implemented project creation with sidebar, dialog form, API, and workspace page
- Created Project Mongoose model with userId, name, description, repoUrl fields
- Created /api/projects route with POST (create) and GET (list by user)
- Built Sidebar component with project list and "New Project" button
- Built NewProjectDialog with name (required), description (optional), repoUrl (optional)
- Created AppShell component (header + sidebar + main content)
- Created /projects/[id] workspace page showing project details
- Updated inbox page to use AppShell layout
- Updated middleware matcher to protect /projects routes
- Added shadcn dialog and textarea components
- Files changed:
  - src/lib/models/project.ts (new)
  - src/app/api/projects/route.ts (new)
  - src/components/sidebar.tsx (new)
  - src/components/new-project-dialog.tsx (new)
  - src/components/app-shell.tsx (new)
  - src/app/projects/[id]/page.tsx (new)
  - src/app/inbox/page.tsx (updated - uses AppShell)
  - src/middleware.ts (updated - added /projects matcher)
  - src/components/ui/dialog.tsx (new - shadcn)
  - src/components/ui/textarea.tsx (new - shadcn)
- **Learnings for future iterations:**
  - AppShell wraps authenticated pages with header + sidebar layout
  - Sidebar re-fetches project list on pathname change (useEffect dep on pathname)
  - Next.js 15 params are Promises — must await them in page components
  - Project pages check userId ownership before rendering
---

## 2026-01-29 - US-04a
- Implemented repository configuration for projects
- Added `repo` subdocument (url, branch, accessTokenArn) to Project Mongoose model
- Created PUT/GET API at /api/projects/[id]/repo with HTTPS Git URL validation
- Built RepoConfigForm client component with URL, branch, access token fields
- Created project settings page at /projects/[id]/settings with repo config section
- Added settings link to project workspace page
- Test Clone button validates URL format (full clone test deferred to backend infra)
- Files changed:
  - src/lib/models/project.ts (updated - added repo subdocument schema)
  - src/app/api/projects/[id]/repo/route.ts (new)
  - src/components/repo-config-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (new)
  - src/app/projects/[id]/page.tsx (updated - added settings link)
  - prd.json (updated - US-04a passes: true)
- **Learnings for future iterations:**
  - Mongoose subdocuments use `{ _id: false }` to avoid auto-generated _id
  - API never returns raw access tokens — only `hasAccessToken` boolean
  - Project settings page is at /projects/[id]/settings (server component renders client form)
  - HTTPS Git URL regex: `/^https:\/\/.+\.git$/`
  - Full clone test requires backend infrastructure (Lambda or similar) — stubbed for now
---

## 2026-01-29 - US-04b
- Implemented agent environment variables configuration for projects
- Added IEnvVar interface and EnvVarSchema to Project model (key, valueArn, source, maskedValue)
- Created /api/projects/[id]/env-vars route with GET, PUT, DELETE methods
- Built EnvVarsConfigForm client component with add/edit/delete key-value pairs
- Added merged env vars preview with masked values and source badges (platform/user)
- Integrated env vars section into project settings page
- Files changed:
  - src/lib/models/project.ts (updated - added IEnvVar, EnvVarSchema, envVars field)
  - src/app/api/projects/[id]/env-vars/route.ts (new)
  - src/components/env-vars-config-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (updated - added env vars section)
  - prd.json (updated - US-04b passes: true)
- **Learnings for future iterations:**
  - Env var keys validated with regex `^[A-Za-z_][A-Za-z0-9_]*$`
  - maskedValue stored in DB to avoid decrypting secrets just to display them
  - API never returns actual secret values — only masked versions
  - Source field distinguishes "platform" (auto-injected provider keys) from "user" (custom)
  - AWS Secrets Manager integration is stubbed with `pending-encryption` placeholder ARN
---

## 2026-01-29 - US-05
- Implemented project rename via settings page
- Created PATCH /api/projects/[id] endpoint with name validation (non-empty, max 100 chars)
- Created ProjectRenameForm client component with inline validation, success/error feedback
- Added "Project Name" section to project settings page (above repo config)
- router.refresh() updates sidebar and header after rename
- Files changed:
  - src/app/api/projects/[id]/route.ts (new)
  - src/components/project-rename-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (updated - added rename section)
  - prd.json (updated - US-05 passes: true)
- **Learnings for future iterations:**
  - Project-level API routes go at /api/projects/[id]/route.ts (PATCH, DELETE, etc.)
  - router.refresh() from next/navigation re-fetches server components, updating sidebar project names
  - Settings page sections order: Project Name > Repository > Env Vars > Danger Zone (delete)
---

## 2026-01-29 - US-06
- Implemented project deletion with confirmation dialog requiring project name typed to confirm
- Added DELETE method to /api/projects/[id] route (findOneAndDelete with userId check)
- Created ProjectDeleteSection client component with two-step confirmation (button → type name → delete)
- Added "Danger Zone" section at bottom of project settings page with destructive styling
- Redirects to /inbox after successful deletion, router.refresh() updates sidebar
- Files changed:
  - src/app/api/projects/[id]/route.ts (updated - added DELETE handler)
  - src/components/project-delete-section.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (updated - added danger zone section)
  - prd.json (updated - US-06 passes: true)
- **Learnings for future iterations:**
  - Danger zone pattern: separate section at bottom with destructive border, requires typing entity name to confirm
  - DELETE endpoint uses findOneAndDelete with userId ownership check
  - Cascade delete for runs/drafts/IaC is handled at DB level when those models exist (currently only project doc)
---

## 2026-01-29 - US-07
- Implemented project switcher dropdown in sidebar (appears when >1 project exists)
- Added localStorage persistence for last-used project ID (key: ralph-last-project-id)
- Created LastProjectRedirect client component that auto-redirects from /inbox to last-used project
- Sidebar saves current project ID to localStorage on navigation
- Files changed:
  - src/components/sidebar.tsx (updated - added switcher dropdown, localStorage helpers, exported getLastProjectId/setLastProjectId)
  - src/components/last-project-redirect.tsx (new - client component for auto-redirect)
  - src/app/inbox/page.tsx (updated - added LastProjectRedirect component)
  - prd.json (updated - US-07 passes: true)
- **Learnings for future iterations:**
  - localStorage helpers (getLastProjectId, setLastProjectId) exported from sidebar.tsx for reuse
  - Project switcher only renders when projects.length > 1 (no switcher for single project)
  - LastProjectRedirect uses router.replace() to avoid adding /inbox to history stack
  - extractProjectId() regex extracts project ID from any /projects/[id]/* pathname
---

## 2026-01-29 - US-08
- Implemented Claude Code API key configuration on project settings page
- Added IProviderKey interface and ProviderKeySchema to Project model (provider, keyArn, maskedValue)
- Created /api/projects/[id]/provider-keys route with GET, PUT, DELETE methods
- Built ProviderKeyForm client component with save, replace, and test-connection functionality
- Added "Provider API Keys" section to project settings page (between Repository and Env Vars)
- Test button validates Claude Code key format (sk-ant- prefix); full API validation deferred to backend
- Files changed:
  - src/lib/models/project.ts (updated - added IProviderKey, ProviderKeySchema, providerKeys field)
  - src/app/api/projects/[id]/provider-keys/route.ts (new)
  - src/components/provider-key-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (updated - added Provider API Keys section)
  - prd.json (updated - US-08 passes: true)
- **Learnings for future iterations:**
  - Provider keys follow same pattern as env vars: masked values stored in DB, never return actual keys
  - VALID_PROVIDERS constant defines allowed providers: claude-code, codeex, opencode
  - ProviderKeyForm is reusable for all providers — just change provider/label/placeholder props
  - Settings page section order: Project Name > Repository > Provider API Keys > Env Vars > Danger Zone
---


## 2026-01-29 - US-09
- Added Codeex provider key form to project settings page
- Added Codeex-specific key format validation (codeex- prefix) in ProviderKeyForm
- Files changed:
  - src/app/projects/[id]/settings/page.tsx (updated - added Codeex ProviderKeyForm)
  - src/components/provider-key-form.tsx (updated - added codeex format validation)
  - prd.json (updated - US-09 passes: true)
- **Learnings for future iterations:**
  - Adding a new provider key is trivial: add another ProviderKeyForm instance in settings page + add format validation in provider-key-form.tsx
  - Provider key prefix conventions: claude-code → sk-ant-, codeex → codeex-, opencode → opencode-
---

## 2026-01-29 - US-10
- Added OpenCode provider key form to project settings page
- Added OpenCode-specific key format validation (opencode- prefix) in ProviderKeyForm
- Files changed:
  - src/app/projects/[id]/settings/page.tsx (updated - added OpenCode ProviderKeyForm)
  - src/components/provider-key-form.tsx (updated - added opencode format validation)
  - prd.json (updated - US-10 passes: true)
- **Learnings for future iterations:**
  - Identical pattern to US-09: add ProviderKeyForm instance + format validation
  - All three providers now configured: claude-code, codeex, opencode
---

## 2026-01-29 - US-11
- Added provider configuration status summary to project workspace page
- Shows all three providers with Configured/Not Configured badges and masked key values
- Links to settings page for key management
- Existing ProviderKeyForm already had status badges and masked display; this adds a read-only overview on the workspace
- Files changed:
  - src/app/projects/[id]/page.tsx (updated - added Provider Status section)
  - prd.json (updated - US-11 passes: true)
- **Learnings for future iterations:**
  - Provider status overview on workspace page complements the editable forms on settings page
  - project.providerKeys array can be accessed directly in server components without API call
---

## 2026-01-29 - US-12
- Added explicit "Rotate" button to ProviderKeyForm for configured providers
- When configured: shows Rotate + Test buttons; clicking Rotate reveals input field with "Rotate Key" save button and Cancel
- When not configured: shows input field with Save button (unchanged behavior)
- Rotation uses existing PUT endpoint which already supports replacing keys
- Files changed:
  - src/components/provider-key-form.tsx (updated - added rotating state, Rotate button UX)
  - prd.json (updated - US-12 passes: true)
- **Learnings for future iterations:**
  - Rotate is functionally identical to Replace — same PUT endpoint, just different UX flow
  - The rotating state hides the input until user explicitly clicks Rotate, reducing accidental overwrites
---

## 2026-01-29 - US-13
- Added Delete button with confirmation dialog to ProviderKeyForm component
- When configured: shows Delete button alongside Rotate and Test
- Clicking Delete shows inline confirmation with "Confirm Delete" and "Cancel" buttons
- On confirm: calls DELETE /api/projects/[id]/provider-keys endpoint (already existed)
- Provider status reverts to "Not Configured" after deletion
- Files changed:
  - src/components/provider-key-form.tsx (updated - added delete confirmation flow)
  - prd.json (updated - US-13 passes: true)
- **Learnings for future iterations:**
  - DELETE endpoint for provider keys already existed from US-08 implementation
  - Inline confirmation pattern (no modal) keeps the UX lightweight for single-action destructive operations
---

## 2026-01-29 - US-14
- Implemented AES-256-GCM encryption for secrets at rest via src/lib/crypto.ts
- Created AuditLog model with fire-and-forget logAudit() helper
- Updated provider-keys and env-vars API routes to encrypt values and log audit entries
- Added ENCRYPTION_KEY to .env.example
- All API responses already return only masked values (first 4 + last 4 chars) — verified no plaintext leaks
- Files changed:
  - src/lib/crypto.ts (new - AES-256-GCM encrypt/decrypt)
  - src/lib/models/audit-log.ts (new - AuditLog model + logAudit helper)
  - src/app/api/projects/[id]/provider-keys/route.ts (updated - encryption + audit logging)
  - src/app/api/projects/[id]/env-vars/route.ts (updated - encryption + audit logging)
  - ralph-orchestrator/.env.example (updated - added ENCRYPTION_KEY)
  - prd.json (updated - US-14 passes: true)
- **Learnings for future iterations:**
  - crypto.ts uses SHA-256 to derive 32-byte key from ENCRYPTION_KEY env var
  - Encrypted format is "iv:authTag:ciphertext" (base64 encoded parts)
  - isEncryptionConfigured() gracefully falls back to "pending-encryption" if no key set
  - AuditLog uses fire-and-forget pattern — logAudit() returns void, errors logged to console
  - Audit entries track: read, create, rotate, update, delete actions on provider-keys and env-vars
---

## 2026-01-29 - US-15
- Implemented AWS region configuration per project
- Added `awsRegion` field to Project model (default: us-east-1)
- Created shared `src/lib/aws-regions.ts` with all AWS regions and human-readable labels
- Extended PATCH /api/projects/[id] to accept `awsRegion` field with validation
- Created AwsRegionForm client component with dropdown of all AWS regions
- Added "AWS Configuration" section to project settings page (between Env Vars and Danger Zone)
- Files changed:
  - src/lib/models/project.ts (updated - added awsRegion field)
  - src/lib/aws-regions.ts (new - AWS_REGIONS constant and labels)
  - src/app/api/projects/[id]/route.ts (updated - PATCH accepts awsRegion)
  - src/components/aws-region-form.tsx (new - region dropdown form)
  - src/app/projects/[id]/settings/page.tsx (updated - added AWS Configuration section)
  - prd.json (updated - US-15 passes: true)
- **Learnings for future iterations:**
  - PATCH /api/projects/[id] now handles multiple fields (name, awsRegion) — extend update object for new project-level fields
  - AWS_REGIONS is a `const` array — use `(AWS_REGIONS as readonly string[]).includes()` for runtime string validation
  - Settings page section order: Project Name > Repository > Provider API Keys > Env Vars > AWS Configuration > AWS Authentication > Danger Zone
---

## 2026-01-29 - US-16
- Implemented AWS authentication configuration with choice of IAM Role ARN or Access Key pair
- Added IAwsAuth interface and AwsAuthSchema to Project model (authType, roleArn, accessKeyId, secretAccessKeyArn, maskedSecretKey)
- Created /api/projects/[id]/aws-auth route with GET, PUT, DELETE methods
- Built AwsAuthForm client component with radio buttons for auth type selection
- IAM Role ARN validated with regex for proper ARN format
- Access key secrets encrypted via AES-256-GCM and stored with masked values
- Added "AWS Authentication" section to project settings page (after AWS Configuration)
- Least-privilege IAM role template link provided
- Files changed:
  - src/lib/models/project.ts (updated - added IAwsAuth, AwsAuthSchema, awsAuth field)
  - src/app/api/projects/[id]/aws-auth/route.ts (new)
  - src/components/aws-auth-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (updated - added AWS Authentication section)
  - prd.json (updated - US-16 passes: true)
- **Learnings for future iterations:**
  - AWS auth uses subdocument pattern like repo config — $unset to remove on DELETE
  - IAM Role ARN regex: `/^arn:aws:iam::\d{12}:role\/[\w+=,.@-]+$/`
  - Secret access keys encrypted same way as provider keys and env vars (AES-256-GCM)
  - Radio buttons for mutually exclusive auth type selection (role vs access-keys)
---

## 2026-01-29 - US-17
- Implemented AWS connectivity test via STS GetCallerIdentity
- Created POST /api/projects/[id]/aws-auth/test endpoint
- For access-keys: decrypts stored secret, creates STS client with credentials, calls GetCallerIdentity
- For role: assumes role via AssumeRole, then calls GetCallerIdentity with assumed credentials
- Added "Test Connection" button to AwsAuthForm with loading state
- Shows AWS Account ID on success, error message on failure
- Installed @aws-sdk/client-sts package
- Files changed:
  - src/app/api/projects/[id]/aws-auth/test/route.ts (new)
  - src/components/aws-auth-form.tsx (updated - added Test Connection button)
  - ralph-orchestrator/package.json (updated - added @aws-sdk/client-sts)
  - prd.json (updated - US-17 passes: true)
- **Learnings for future iterations:**
  - @aws-sdk/client-sts is the AWS SDK v3 package for STS operations
  - For role-based auth, need AssumeRole first then use temporary credentials for GetCallerIdentity
  - decrypt() from crypto.ts recovers the stored secret access key for runtime use
  - Test endpoint is a separate route at /aws-auth/test to keep concerns separated from CRUD
---

## 2026-01-29 - US-18
- Implemented AWS credential update flow with edit/read-only toggle
- When configured: shows read-only summary with masked values, Edit/Test/Remove buttons
- Clicking Edit reveals editable form pre-filled with current values (masked secret)
- On update: saves credentials then auto-runs test connection for validation
- Cancel button returns to read-only view without saving
- Running agents unaffected — note shown that new credentials apply on next iteration
- Files changed:
  - src/components/aws-auth-form.tsx (updated - added editing state, read-only summary view, validation on update)
  - prd.json (updated - US-18 passes: true)
- **Learnings for future iterations:**
  - Edit toggle pattern: `editing` state starts false when configured, true when not
  - Post-save validation: save first, then test connection, report combined result
  - Cancel edit resets to read-only without API call
---

## 2026-01-29 - US-19
- Implemented IaC template selector with three options: Fargate, Lambda, EC2 Spot
- Created src/lib/iac-templates.ts with template data (id, name, description, estimated cost range)
- Added iacTemplate field to Project model
- Extended PATCH /api/projects/[id] to accept and validate iacTemplate
- Created IacTemplateSelector client component with card-style radio selection
- Added "IaC Template" section to project settings page (between AWS Authentication and Danger Zone)
- Files changed:
  - src/lib/iac-templates.ts (new - IaC template definitions)
  - src/lib/models/project.ts (updated - added iacTemplate field)
  - src/app/api/projects/[id]/route.ts (updated - PATCH accepts iacTemplate)
  - src/components/iac-template-selector.tsx (new - template selector component)
  - src/app/projects/[id]/settings/page.tsx (updated - added IaC Template section)
  - prd.json (updated - US-19 passes: true)
- **Learnings for future iterations:**
  - IaC templates defined in src/lib/iac-templates.ts — add new templates there
  - IAC_TEMPLATE_IDS exported for runtime validation in API routes
  - Settings page section order: Project Name > Repository > Provider API Keys > Env Vars > AWS Configuration > AWS Authentication > IaC Template > Danger Zone
---

## 2026-01-29 - US-20
- Implemented IaC file generation from selected Pulumi templates (Fargate, Lambda, EC2 Spot)
- Added IIacFile interface and iacFiles field to Project model
- Created src/lib/iac-generators.ts with template-specific Pulumi TypeScript generators
- Created POST /api/projects/[id]/iac-generate endpoint that generates and stores files
- Built IacGenerateSection client component with Generate button and tabbed file viewer
- Added Infrastructure as Code section to project workspace page
- Files changed:
  - src/lib/models/project.ts (updated - added IIacFile interface, iacFiles field)
  - src/lib/iac-generators.ts (new - Pulumi template generators per template type)
  - src/app/api/projects/[id]/iac-generate/route.ts (new - POST endpoint)
  - src/components/iac-generate-section.tsx (new - generate button + file viewer)
  - src/app/projects/[id]/page.tsx (updated - added IaC section)
  - prd.json (updated - US-20 passes: true)
- **Learnings for future iterations:**
  - IaC generators live in src/lib/iac-generators.ts — add new templates there with a generator function
  - iacFiles stored as array of {path, content} objects directly in the Project document
  - Generate endpoint is POST /api/projects/[id]/iac-generate — overwrites previous files on regenerate
  - IacGenerateSection component shows tabbed file viewer with syntax-highlighted code
  - Template generators receive projectName and awsRegion as options
---

## 2026-01-29 - US-21
- Replaced plain `<pre>` code viewer with Monaco editor in read-only mode
- Added file tree sidebar for multi-file navigation (replaces tab strip)
- Monaco editor provides TypeScript syntax highlighting, line numbers, word wrap
- Language auto-detected from file extension (.ts, .js, .json, .yaml)
- Files changed:
  - src/components/iac-generate-section.tsx (updated - Monaco editor + file tree sidebar)
  - ralph-orchestrator/package.json (updated - added @monaco-editor/react)
  - prd.json (updated - US-21 passes: true)
- **Learnings for future iterations:**
  - @monaco-editor/react is the React wrapper for Monaco; import as `Editor` from `@monaco-editor/react`
  - Use `readOnly: true` and `domReadOnly: true` options together for truly read-only Monaco
  - Monaco needs explicit height (not auto); use container with fixed height
  - File tree sidebar pattern: left panel (w-48) + flex-1 editor area
---

## 2026-01-29 - US-22
- Implemented edit mode toggle for IaC files in Monaco editor
- Added Edit/Cancel Edit/Save buttons to IaC generate section toolbar
- Monaco editor switches between readOnly and editable modes
- TypeScript syntax validation via Monaco markers — blocks save if errors exist
- Created PUT /api/projects/[id]/iac-files endpoint for saving edited files
- Cancel edit reverts to original files (unsaved changes discarded)
- Files changed:
  - src/components/iac-generate-section.tsx (updated - edit mode, save, marker validation)
  - src/app/api/projects/[id]/iac-files/route.ts (new - PUT endpoint for saving)
  - prd.json (updated - US-22 passes: true)
- **Learnings for future iterations:**
  - Monaco `onMount` callback gives access to both editor instance and monaco namespace
  - Use `editor.IMarker` type from `monaco-editor` for marker type annotations
  - `monacoRef.current.editor.getModelMarkers()` returns all markers for validation
  - `OnMount` type imported from `@monaco-editor/react` for proper typing
  - Cancel edit should revert to `initialFiles` prop (server state), not last saved state
---
