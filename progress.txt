## Codebase Patterns
- Next.js 14+ App Router with src/ directory and @/* import alias
- shadcn/ui initialized with Tailwind v4, CSS variables
- MongoDB connection uses global cache singleton pattern in src/lib/db.ts
- Type definitions live in src/lib/types/
- Auth config in src/lib/auth.ts using next-auth
- User model in src/lib/models/user.ts (Mongoose)
- NextAuth v5 beta uses `next-auth/providers/credentials` and `next-auth/providers/github` imports
- Signup is a custom API route at /api/auth/signup (not part of NextAuth)
- Auth pages use route group `(auth)` with login/ and signup/ directories
- shadcn/ui components added via `npx shadcn@latest add <component>`
- SessionProvider wrapper lives in src/components/session-provider.tsx (client component)
- UserMenu component uses useSession() from next-auth/react for client-side session access
- Root layout wraps children with AuthSessionProvider for client-side session access
- AppShell component provides shared layout (header + sidebar + main content area)
- Sidebar fetches projects from /api/projects on each pathname change
- Project model in src/lib/models/project.ts (Mongoose)
- Projects API at /api/projects (GET list, POST create)
- Middleware matcher must include /projects/:path* for auth protection
- Project settings page at /projects/[id]/settings — server component with client form components
- API routes for project sub-resources follow /api/projects/[id]/{resource} pattern
- Never return secrets from API — use boolean flags (e.g., hasAccessToken)
---

## 2026-01-28 - US-01
- Implemented sign up and sign in with email/password credentials and GitHub OAuth
- Configured NextAuth.js with JWT sessions (7-day expiry), credentials + GitHub providers
- Created User Mongoose model with email, password (bcrypt hashed), name, emailVerified fields
- Built login page with email/password form and GitHub OAuth button
- Built signup page with name/email/password form and GitHub OAuth button
- Created /api/auth/signup POST route with validation and bcrypt hashing
- Created /api/auth/[...nextauth] route handler
- Added middleware for protected routes
- Updated home page to redirect based on auth state
- Files changed:
  - src/lib/auth.ts (NextAuth config)
  - src/lib/models/user.ts (new)
  - src/app/api/auth/[...nextauth]/route.ts (new)
  - src/app/api/auth/signup/route.ts (new)
  - src/app/(auth)/login/page.tsx (new)
  - src/app/(auth)/signup/page.tsx (new)
  - src/middleware.ts (new)
  - src/app/page.tsx (updated to redirect)
  - src/components/ui/ (button, input, label, card, separator via shadcn)
- **Learnings for future iterations:**
  - NextAuth v5 beta exports `auth` which can be used directly as middleware export
  - GitHub OAuth auto-creates users in the signIn callback (no adapter needed for basic flow)
  - Email verification is a TODO - placeholder noted in signup route
  - bcryptjs used instead of bcrypt for easier cross-platform install
---

## 2026-01-28 - US-02
- Implemented sign out via user menu dropdown
- Created UserMenu client component with avatar, dropdown, and sign out action
- Created AuthSessionProvider wrapper for next-auth/react SessionProvider
- Wrapped root layout with AuthSessionProvider
- Created /inbox page as authenticated landing page with header and UserMenu
- Added shadcn dropdown-menu and avatar components
- Files changed:
  - src/components/user-menu.tsx (new)
  - src/components/session-provider.tsx (new)
  - src/app/layout.tsx (updated - added SessionProvider wrapper, updated metadata)
  - src/app/inbox/page.tsx (new)
  - src/components/ui/dropdown-menu.tsx (new - shadcn)
  - src/components/ui/avatar.tsx (new - shadcn)
- **Learnings for future iterations:**
  - next-auth/react `signOut({ callbackUrl: "/login" })` handles JWT invalidation and redirect
  - `useSession()` requires SessionProvider ancestor - wrapped in root layout
  - UserMenu is a client component; inbox page is a server component that renders it
---

## 2026-01-28 - US-04
- Implemented project creation with sidebar, dialog form, API, and workspace page
- Created Project Mongoose model with userId, name, description, repoUrl fields
- Created /api/projects route with POST (create) and GET (list by user)
- Built Sidebar component with project list and "New Project" button
- Built NewProjectDialog with name (required), description (optional), repoUrl (optional)
- Created AppShell component (header + sidebar + main content)
- Created /projects/[id] workspace page showing project details
- Updated inbox page to use AppShell layout
- Updated middleware matcher to protect /projects routes
- Added shadcn dialog and textarea components
- Files changed:
  - src/lib/models/project.ts (new)
  - src/app/api/projects/route.ts (new)
  - src/components/sidebar.tsx (new)
  - src/components/new-project-dialog.tsx (new)
  - src/components/app-shell.tsx (new)
  - src/app/projects/[id]/page.tsx (new)
  - src/app/inbox/page.tsx (updated - uses AppShell)
  - src/middleware.ts (updated - added /projects matcher)
  - src/components/ui/dialog.tsx (new - shadcn)
  - src/components/ui/textarea.tsx (new - shadcn)
- **Learnings for future iterations:**
  - AppShell wraps authenticated pages with header + sidebar layout
  - Sidebar re-fetches project list on pathname change (useEffect dep on pathname)
  - Next.js 15 params are Promises — must await them in page components
  - Project pages check userId ownership before rendering
---

## 2026-01-29 - US-04a
- Implemented repository configuration for projects
- Added `repo` subdocument (url, branch, accessTokenArn) to Project Mongoose model
- Created PUT/GET API at /api/projects/[id]/repo with HTTPS Git URL validation
- Built RepoConfigForm client component with URL, branch, access token fields
- Created project settings page at /projects/[id]/settings with repo config section
- Added settings link to project workspace page
- Test Clone button validates URL format (full clone test deferred to backend infra)
- Files changed:
  - src/lib/models/project.ts (updated - added repo subdocument schema)
  - src/app/api/projects/[id]/repo/route.ts (new)
  - src/components/repo-config-form.tsx (new)
  - src/app/projects/[id]/settings/page.tsx (new)
  - src/app/projects/[id]/page.tsx (updated - added settings link)
  - prd.json (updated - US-04a passes: true)
- **Learnings for future iterations:**
  - Mongoose subdocuments use `{ _id: false }` to avoid auto-generated _id
  - API never returns raw access tokens — only `hasAccessToken` boolean
  - Project settings page is at /projects/[id]/settings (server component renders client form)
  - HTTPS Git URL regex: `/^https:\/\/.+\.git$/`
  - Full clone test requires backend infrastructure (Lambda or similar) — stubbed for now
---

